FROM       python:3-alpine@sha256:95217fdd1431fe6230e033513670673c81a50debdb0065e54cbda261f3d76528 AS builder
SHELL      ["/bin/ash", "-e", "-o", "pipefail", "-c"]
RUN        apk --no-cache add build-base=0.5-r2 curl=7.74.0-r1
RUN        curl -L @JO_DIST_URL@ -o jo.tar.gz
RUN        echo '@JO_DIST_SHA256@  jo.tar.gz' | sha256sum -c
RUN        tar xvf jo.tar.gz
WORKDIR    /jo-@JO_VERSION@
RUN        ./configure && make && make install
RUN        python -m venv /discord-bot
RUN        /discord-bot/bin/pip install --disable-pip-version-check \
                                        --no-cache-dir --no-deps wheel==0.36.2
RUN        /discord-bot/bin/pip install --disable-pip-version-check \
                                        --no-cache-dir --no-deps \
                                        @PYTHON_DEPENDENCIES@
COPY       bot/ /discord-bot/bot/
WORKDIR    /discord-bot
RUN        python -m compileall bot

FROM       python:3-alpine@sha256:95217fdd1431fe6230e033513670673c81a50debdb0065e54cbda261f3d76528
ENV        APPTOKEN=unset
ENV        CHECKFORUPDATES=false
ENV        LANGUAGE=en-us
ENV        COMMANDPREFIX=!
ENV        DEBUG=false
ENV        SUPPESSWARNINGS=true
COPY       --from=builder /usr/local/bin/jo /usr/local/bin
COPY       --from=builder /discord-bot /discord-bot
COPY       start /discord-bot
RUN        chmod 0555 /discord-bot/start
RUN        addgroup -S aarrr && \
           adduser -S -H -h /nonexistent -s /sbin/nologin \
                   -G aarrr -g 'Avast me lovelies' aarrr
RUN        install -m 0600 -o aarrr -g aarrr /dev/null \
                                             /discord-bot/settings.json
USER       aarrr
ENTRYPOINT ["/discord-bot/start"]
